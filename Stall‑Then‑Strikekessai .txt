Strategy #1「静止→一撃（Stall‑Then‑Strike）」の決済ロジックだけを、ゆっくり整理しますね。
（あなたが「次」と送ってくれたら、Strategy #2 以降も同じノリでやっていきます）

Step 1：Strategy #1 の決済ロジックを分解して確認
1. そもそも「いつポジションを持つのか（エントリー条件のおさらい）」

このストラテジーは、
Best Bid / Best Ask が T ms 以上まったく動かない
かつ
スプレッドが 1〜2 tick 以上ひらいている
ときだけ、「ちょっとだけ勝ちやすい時間」と見なします。
その瞬間だけ、
mid − 1tick に最小ロットの買い指値
mid + 1tick に最小ロットの売り指値
を出します（どちらも ttl_ms 付き）。
ここから「決済（どうやって終わらせるか）」がスタートです。

2. 「ポジションが発生した」とみなすタイミング
この戦略では、
どちらか片方の指値が約定した瞬間
に「ポジションを持った」とみなします。
買いだけ約定 → ロング在庫（Q > 0）
売りだけ約定 → ショート在庫（Q < 0）
もう片側の指値は、
ヘッジ（反対側の板に残しておく）
または
すぐキャンセルして、別の決済注文を出す
のどちらかを選ぶ設計にできますが、基本の考え方は「すぐ薄利で抜ける」です。

3. 理想パターンの決済ロジック（薄利確定）
理想形はこうです：
静止中に mid±1tick に両面を出す
どちらかが 1tick 内側で約定する
そのすぐ後に、
反対サイドへ IOC で +1tick 程度の利確注文を出す
IOC が通れば、数 tick の利確でポジションゼロに戻る
ドキュメントの言い方だと、
「約定した側は IOC で薄利確定（または反対側に残す）」
これが #1 の基本決済ロジックです。

4. 「撤退」＝決済・キャンセルが走る条件（損失側・様子見中止）
このストラテジーでは、「もうこのチャンスは終わり」と判断したらすぐにポジションを畳む or 注文を引っ込めるのがルールです。条件は：
Best が動いた瞬間
さっきまでピタッと止まっていた Best Bid / Ask のどちらかが変わったら、
両側の未約定注文を 即キャンセル
もし在庫を持っていたら、
近い側の板（ベスト or その1tick内側）で できるだけ早くクローズ
価格が逆行したとき（1〜2 tick 逆向き）
期待とは逆向きに 1〜2tick 動いたら、
利確をあきらめて、成行寄り or 近い指値で損切り決済
（在庫をゼロに戻す）
TTL 超過（実装版のルール）
各注文には ttl_ms を持たせているので、
その時間内に約定しなかった注文は自動キャンセル
ポジションを持っている状態で TTL が切れた場合は、
「もうこの一撃は終わった」とみなし、
ルールに従ってクローズ注文を出す（近い板で逃がす）

つまり Strategy #1 の「撤退条件」は、ドキュメント的には：
Best が動いた瞬間
逆行 1〜2 tick
TTL 超過
で、どれかを満たしたら“その場の勝負を終わらせる”、というイメージです。

5. 全ストラテジー共通の「強制決済・全キャンセル」も効いている
#1 だけの話ではなく、全戦略共通で、
30 秒の mid 変化率が 0.25% を超えたとき（急変動）
連続成行の z-score が上がって「毒性が高い」とき
在庫が max_inventory を超えそうなとき
などは、戦略に関係なく全キャンセル＋在庫縮小（Kill-Switch） が動きます。
だから Strategy #1 の決済ロジックは、
局所的な「一撃」の中での利確・損切り／キャンセル
その外側にある共通リスクレイヤーの強制クローズ
の二重構造になっています。
ここまでが Strategy #1「静止→一撃」 の決済ロジックの整理です。


