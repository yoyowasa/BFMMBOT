STRATEGY #2「キャンセル比ゲート（Cancel/Add Gate）」の決済／撤退ロジック を、ゆっくり整理しますね。
（終わったら、また「次」と送ってくれれば #3 に進みます）

STEP 2：STRATEGY #2 キャンセル比ゲートの決済ロジック
0. このストラテジーのざっくりイメージ

「板が“落ち着いているときだけ”片側で厚めに出すMM」です。

「落ち着いているかどうか」を、

Best層の Cancel 数 / Add 数（C/A 比率） で判定します。

キャンセルが増えた＝雰囲気が怪しい となったら、
→ すぐ 注文を引っ込めて撤退 するのが決済ロジックの中心です。

ここでは、

いつ出して

いつ「やめるか」（撤退・キャンセル）

それが在庫（ポジション）の決済とどうつながるか

を順番に見ます。

1. エントリー条件（おさらい）

この戦略で 注文を出してよい瞬間 は：

直近 ca_ratio_win_ms（例：500ms）で見た
Best層の C/A 比（Cancel / Add）がしきい値以下

例： C/A ≤ 1.3 なら「落ち着いている板」

スプレッドが 1tick 以上 開いている

このときだけ、

ミッド ±1〜2tick あたりで

片側（有利そうな側）に、少し厚めの指値 を出します
（片側MM：例として、Microprice寄りの側に出す）

各注文には ttl_ms（寿命）も付いています。

2. 「利確」のイメージ（どうやって勝ちパターンになるか）

この戦略は #1 と違って、

「一発打ってすぐIOCで閉じる」 というより、

「C/A が低い（落ち着いた板）の間だけ、受け身でコツコツ約定をもらう」 タイプです。

だから「利確ロジック」は：

自分の厚めの指値がヒットした瞬間に

その約定が そのまま利確 or 期待値プラスのトレード になる

その後も C/A 比が低い状態が続いているあいだだけ、

同じような位置に再び提⽰してコツコツ回す

という “ストリーミング系のMM” です。

ここで大事なのは、

「いつポジションを増やすのをやめるか」＝撤退条件

であって、#2 固有の「特別な利確指値」はあまり強調されていません。
決済（クローズ）の細かいやり方は、後ろにいる 共通リスクレイヤー が担当します（在庫上限超えたら flatten など）。

3. STRATEGY #2 の「撤退・キャンセル」条件

このストラテジーで一番大事な「決済ロジック」は、

“板の毒性が上がったら、すぐ注文を引っ込める”

という部分です。具体的には：

(A) C/A 比がしきい値を超えたとき

直近 ca_ratio_win_ms で見た C/A 比が ca_threshold を上回った瞬間：

例：

ふだん：C/A ≤ 1.3 → OK

だんだん：1.3 を超えてくる → キャンセル優勢＝板が逃げ始めた

このときにやること：

#2 で出している注文（tag="ca_gate" など）を全部キャンセル

同じ条件に戻るまでは 新しい #2 注文を出さない

👉 つまり、「キャンセルが増えたら、その場の勝負はやめる」が基本です。

(B) 連続成行（taker）の z-score が上がったとき

直近の成行（マーケット注文）が 同じ向きに連続で出ている と、

「今は taker が積極的に殴りに来ている＝毒性が高い」

ドキュメントでは：

撤退：C/A 上昇、連続成行の z-score↑。

この条件を満たしたら：

#2 の注文を すべてキャンセル

新規は止めて、状況が落ち着くまで様子見

👉 「板が逃げている」か「成行が突っ込んでいる」どちらかが見えたら、すぐ撤退 です。

(C) TTL 超過（その一枚を引き上げるタイミング）

各注文には ttl_ms が付いていて、
その時間のあいだ約定しなかったら、自動でキャンセル されます。

イメージ：

「この場所で 800ms 以内に約定しないなら、その一枚はもう役割を終えたから下げる」

TTL 超過後、

まだ C/A 比が低くて条件OKなら → 新しい位置にあらためて出し直し

条件NGなら → そのまま撤退（新規を出さない）

👉 これで「古くて危ない見せ板」を残さないようにしています。

(D) 共通ガード（急変時の強制クローズ）

STRATEGY #2 の内側だけでなく、全戦略共通の Kill-Switch / ガード も効きます：

例：

30秒の mid 変化率が 0.25% 超え

在庫が max_inventory 超え

連続成行 z-score が全体として高騰

これらが発火すると：

#2 の注文も 全部キャンセル

必要なら在庫は risk モジュール側で強制縮小（flatten）

👉 つまり、

#2 のローカルルール
+

共通リスクレイヤー

の二重構造で「決済（撤退）」が走ります。

4. まとめ（子ども向けに一言）

STRATEGY #2 の決済／撤退ロジックを、一言で言うと：

「キャンセルが増えたり、成行がドドドッと来たら、
すぐ板から引っ込んで逃げるMM」

C/A 比がしきい値を超えたら → 即キャンセル＋新規ストップ

連続成行 z-score が上がったら → 同じく撤退

TTL を過ぎた古い注文は → 自動キャンセル

さらに外側では → 急変・在庫上限などの Kill-Switch で強制クローズ