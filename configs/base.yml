# configs/base.yml: 共通の土台設定（paper/live/backtest で上書き前提）
# - 戦略しきい値（features.*）とガード/リスク/窓/ログをまとめる
# - 窓切替や安全装置が読む基準値

env: paper  # 既定は paper（環境ファイルで上書き）
product_code: FX_BTC_JPY
tick_size: 1  # 1 tick = 1 JPY

tx:
  min_interval_ms: 1000    # 送信間隔の最小値
  place_dedup_ms: 1000     # 同一内容の短時間重複を抑止

fees:
  # bitFlyer Crypto CFD（FX_BTC_JPY相当）の売買手数料は原則「無料」扱い（詳細は bitFlyer公式の手数料ページ参照）
  # - ここは“売買手数料(commission)”のみ。ファンディング/レバレッジポイント等は別枠。
  bps: 0.0

orders:
  max_inflight: null

gate:
  max_inflight_per_key: null

size:  # 取引サイズ
  min: 0.001
  default: 0.001  # デフォルトロットを最小ロットに下げて、必要証拠金を小さくする

risk:  # 上限・非常停止
  max_inventory: 0.05       # 在庫の絶対上限（BTC）
  limit_qty: null
  inventory_eps: 0.002      # 上限手前の安全マージン
  inv_capping:
    enabled: true
    target_ratio: 0.90
    eff_limit_margin: 0.99
  kill:
    daily_pnl_jpy: -30000   # 日次PnL下限
  auto_reduce:              # 在庫“自動薄め”ブロック（既定OFF。envで上書き可）
    enabled: false
    profit_only: false
    force_on_risk: true
    tif: IOC
    min_step_qty: 0.001
    max_dd_jpy: -20000

guard:  # 相場が速いときのブレーキ
  max_mid_move_bp_30s: 25
  zero_spread:
    suppress_ms: 300       # アルパカスプレッド持続の閾値(ms)超過で新規注文を抑制
    cooldown_ms: 600       # 抑制解除までのクールダウン(ms)
    max_block_ms: 3000     # 連続ゼロスプレッドでのブロック上限(ms)
    min_place_spread_tick: 1  # 0tick相当では新規注文を出さない
  feed_health:
    age_ms:
      caution: 3000
      halted: 10000
    heartbeat_gap_sec:
      caution: 3
      halted: 10
    recover_ok_consecutive: 2
    cooldown_sec: 10
  caution:
    max_order_size: 0.001
    max_order_rate_per_sec: 2

mode_switch:  # 窓の扱い（メンテ/ファンディング）
  maintenance: { start: "04:00:00", end: "04:10:00", action: "pause" }
  funding_calc_jst: ["06:00:00","14:00:00","22:00:00"]
  funding_transfer_lag_hours: 8

latency:  # 固定遅延モデル（実測に置換予定）
  rx_ms: 20
  tx_ms: 20

health:
  stale_sec_warn: 3   # Best 3s 無更新で Caution
  stale_sec_halt: 10  # Best 10s 無更新で Halted

features:  # 戦略の共通しきい値（#1/#2 の主材料）
  stall_T_ms: 240              # #1: Best静止トリガ時間(ms)
  ca_ratio_win_ms: 600         # #2: C/A比を測る窓(ms)
  ca_ratio_cap: 10.0           # #2: 計測時のC/A比をこの上限でクリップ（異常値抑止）
  ca_threshold: 1.25           # #2: C/A比がこの値以下なら“静か”
  min_spread_tick: 1           # 共通: 最低スプレッドtick
  ttl_ms: 900                  # 共通: 注文寿命(ms)
  stall_ttl_ms: 650            # #1: STだけ寿命を短く
  stall_min_mp_edge_bp: 0.0
  zero_min_mp_edge_bp: 0.0
  zero_min_mp_edge_bp_sell: 1.5  # スプレッド0時の売り側MPエッジ下限(bps)。この値未満のsellを止める
  age_ms: 200                  # Age×MP 用滞留時間(ms)
  mp_offset_tick: 1.0          # Micropriceのずらしtick
  tiny_prints_N: 20            # Tiny-Prints集計件数
  tiny_prints_minCount: 14     # Tiny-Prints発火閾値
  eta_t_window_ms: 800         # Queue ETAの窓(ms)
  ca_gate_block_min_abs_inv: 0.04  # #2: 在庫帯ブロック下限|Q|
  ca_gate_block_max_abs_inv: 0.06  # #2: 在庫帯ブロック上限|Q|
  zero_reopen_pop:
    min_take_qty: 0.0
    max_join_qty: 0.0
    exact_one_tick_only: true
    ttl_jitter_ms: 80
    min_best_age_ms: 200
    reopen_stable_ms: 50
    loss_cooloff_ms: 1500
    fee_maker_bp: 0.0
    fee_taker_bp: 0.0
    edge_bp_min: 0.0
    max_speed_ticks_per_s: 12.0
    min_spread_tick: 1
    max_spread_tick: 2
    ttl_ms: 800
    stop_adverse_ticks: 2
    entries_window_ms: 10000
    max_entries_in_window: 6
    size_min: 0.001
    cooloff_ms: 250
    seen_zero_window_ms: 1000

# デフォルトONにする戦略（CLI --strategy があればそちら優先）
strategies:
  - stall_then_strike
  - cancel_add_gate

logging:
  level: DEBUG
  rotate_mb: 128
  run_log_template: logs/runtime/run.log
  strategy_log_template: null
  strategy_level: null

# 戦略ごとの固有設定をまとめる
strategy_cfg:
  stall_then_strike:
    # 静止→一撃 (#1) の発注ロットと決済/撤退の目安
    size:
      default: 0.001
    min_requote_interval_ms: 1500  # 条件外撤退後の再エントリー抑止間隔
    take_profit_ticks: 1.0          # エントリー±このtickでIOC利確
    stop_ticks: 2.0                 # 逆行このtickで撤退IOC
    buy_momentum_filter:
      window_ms: 2000       # 直近windowでのミッド変化率を見る窓
      threshold_bps: 3.0    # これ以上の上昇なら買い側を抑制
      mode: sell_only       # 抑制時の動作（sell_only/halt_both）
    ttl_bands:
      - { threshold_bp: 1.5, ttl_ms: 400, window_ms: 1000 }  # 変化が遅いときは長め
      - { threshold_bp: 5.0,  ttl_ms: 300, window_ms: 1000 } # 変化が速いときは短め
  cancel_add_gate:
    # C/Aゲート (#2) の発注ロット
    size:
      default: 0.007
    taker_zscore_threshold: null   # 連続成行の毒性zscoreがこの値を超えたら撤退（nullで無効）

env_overrides:
  live:
    env: live
    size:
      default: 0.001
    risk:
      max_inventory: 0.001      # 最大建玉を1本分に抑制（0.001 BTC）
      inventory_eps: 0.0        # 余白なし（0.001ちょうどまで許容）
    guard:
      max_mid_move_bp_30s: 25  # テスト用に許容幅を25bpへ緩和
      zero_spread:
        suppress_ms: 300       # アルパカスプレッド長期の閾値(ms)超過で新規抑制
        cooldown_ms: 600       # 抑制解除までのクールダウン(ms)
        max_block_ms: 3000     # アルパカスプレッドでのブロック上限(ms)
        min_place_spread_tick: 1  # 0tick相当では新規注文を出さない
    logging:
      level: INFO
